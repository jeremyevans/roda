<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>Roda::RodaPlugins::Sessions::RequestMethods</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='class' id='wrapper'>
<div class='header'>
<h1 class='name'><span class='type'>module</span>
Roda::RodaPlugins::Sessions::RequestMethods
</h1>
<ol class='paths'>
<li>
<a href="../../../../files/lib/roda/plugins/sessions_rb.html">lib/roda/plugins/sessions.rb</a>
</li>
</ol>
</div>
<div id='content'>
<div id='text'>
<div id='description'></div>
<div id='method-list'>
<h2>Methods</h2>
<h3>Public Instance</h3>
<ol>
<li><a href="#method-i-persist_session">persist_session</a></li>
<li><a href="#method-i-session">session</a></li>
<li><a href="#method-i-session_created_at">session_created_at</a></li>
<li><a href="#method-i-session_updated_at">session_updated_at</a></li>
</ol>
</div>
<div id='context'>
</div>
<div id='section'>
<div id='methods'>
<h2>Public Instance methods</h2>
<div class='method public-instance' id='method-method-i-persist_session'>
<a name='method-i-persist_session'></a>
<div class='synopsis'>
<span class='name'>persist_session</span><span class='arguments'>(headers, session)</span>

</div>
<div class='description'>

<p>Persist the session data as a cookie.  If transparently upgrading from Rack::Session::Cookie, mark the related cookie for expiration so it isnâ€™t sent in the future.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-persist_session-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-persist_session-source'>    <span class="ruby-comment"># File lib/roda/plugins/sessions.rb</span>
<span class="line-num">261</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">persist_session</span>(<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">session</span>)
<span class="line-num">262</span>   <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">roda_class</span>.<span class="ruby-identifier">opts</span>[<span class="ruby-value">:sessions</span>]
<span class="line-num">263</span> 
<span class="line-num">264</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">session</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">265</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">env</span>[<span class="ruby-constant">SESSION_SERIALIZED</span>]
<span class="line-num">266</span>       <span class="ruby-comment"># If session was submitted and is now empty, remove the cookie</span>
<span class="line-num">267</span>       <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Utils</span>.<span class="ruby-identifier">delete_cookie_header!</span>(<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">opts</span>[<span class="ruby-value">:key</span>], <span class="ruby-identifier">opts</span>[<span class="ruby-value">:remove_cookie_options</span>])
<span class="line-num">268</span>     <span class="ruby-comment"># else</span>
<span class="line-num">269</span>       <span class="ruby-comment"># If no session was submitted, and the session is empty</span>
<span class="line-num">270</span>       <span class="ruby-comment"># then there is no need to do anything</span>
<span class="line-num">271</span>     <span class="ruby-keyword">end</span>
<span class="line-num">272</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">cookie_value</span> = <span class="ruby-identifier">_serialize_session</span>(<span class="ruby-identifier">session</span>)
<span class="line-num">273</span>     <span class="ruby-identifier">cookie</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-identifier">opts</span>[<span class="ruby-value">:cookie_options</span>]]
<span class="line-num">274</span>     <span class="ruby-identifier">cookie</span>[<span class="ruby-value">:value</span>] = <span class="ruby-identifier">cookie_value</span>
<span class="line-num">275</span>     <span class="ruby-identifier">cookie</span>[<span class="ruby-value">:secure</span>] = <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">cookie</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-value">:secure</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ssl?</span>
<span class="line-num">276</span> 
<span class="line-num">277</span>     <span class="ruby-identifier">before_size</span> = <span class="ruby-keyword">if</span> (<span class="ruby-identifier">set_cookie_before</span> = <span class="ruby-identifier">headers</span>[<span class="ruby-constant">RodaResponseHeaders</span><span class="ruby-operator">::</span><span class="ruby-constant">SET_COOKIE</span>]).<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
<span class="line-num">278</span>       <span class="ruby-identifier">set_cookie_before</span>.<span class="ruby-identifier">bytesize</span>
<span class="line-num">279</span>     <span class="ruby-keyword">else</span>
<span class="line-num">280</span>       <span class="ruby-value">0</span>
<span class="line-num">281</span>     <span class="ruby-keyword">end</span>
<span class="line-num">282</span> 
<span class="line-num">283</span>     <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Utils</span>.<span class="ruby-identifier">set_cookie_header!</span>(<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">opts</span>[<span class="ruby-value">:key</span>], <span class="ruby-identifier">cookie</span>)
<span class="line-num">284</span> 
<span class="line-num">285</span>     <span class="ruby-identifier">cookie_size</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">set_cookie_after</span> = <span class="ruby-identifier">headers</span>[<span class="ruby-constant">RodaResponseHeaders</span><span class="ruby-operator">::</span><span class="ruby-constant">SET_COOKIE</span>]
<span class="line-num">286</span>     <span class="ruby-keyword">when</span> <span class="ruby-constant">String</span>
<span class="line-num">287</span>       <span class="ruby-comment"># Rack &lt; 3 always takes this branch, combines cookies into string, subtract previous size</span>
<span class="line-num">288</span>       <span class="ruby-comment"># Rack 3+ takes this branch if this is the first cookie set, in which case before size is 0</span>
<span class="line-num">289</span>       <span class="ruby-identifier">set_cookie_after</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">before_size</span>
<span class="line-num">290</span>     <span class="ruby-keyword">else</span> <span class="ruby-comment"># when Array</span>
<span class="line-num">291</span>       <span class="ruby-comment"># Rack 3+ takes branch if this is not the first cookie set, and last element of the array</span>
<span class="line-num">292</span>       <span class="ruby-comment"># is most recently added cookie</span>
<span class="line-num">293</span>       <span class="ruby-identifier">set_cookie_after</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">bytesize</span>
<span class="line-num">294</span>     <span class="ruby-keyword">end</span>
<span class="line-num">295</span> 
<span class="line-num">296</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">cookie_size</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">4096</span>
<span class="line-num">297</span>       <span class="ruby-identifier">raise</span> <span class="ruby-constant">CookieTooLarge</span>, <span class="ruby-node">&quot;attempted to create cookie larger than 4096 bytes (bytes: #{cookie_size})&quot;</span>
<span class="line-num">298</span>     <span class="ruby-keyword">end</span>
<span class="line-num">299</span>   <span class="ruby-keyword">end</span>
<span class="line-num">300</span>   
<span class="line-num">301</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">env</span>[<span class="ruby-constant">SESSION_DELETE_RACK_COOKIE</span>]
<span class="line-num">302</span>     <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Utils</span>.<span class="ruby-identifier">delete_cookie_header!</span>(<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">opts</span>[<span class="ruby-value">:upgrade_from_rack_session_cookie_key</span>], <span class="ruby-identifier">opts</span>[<span class="ruby-value">:upgrade_from_rack_session_cookie_options</span>])
<span class="line-num">303</span>   <span class="ruby-keyword">end</span>
<span class="line-num">304</span> 
<span class="line-num">305</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">306</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-session'>
<a name='method-i-session'></a>
<div class='synopsis'>
<span class='name'>session</span><span class='arguments'>()</span>

</div>
<div class='description'>

<p>Load the session information from the cookie.  With the sessions plugin, you must call this method to get the session, instead of trying to access the session directly through the request environment. For maximum compatibility with other software that uses rack sessions, this method stores the session in â€˜rack.sessionâ€™ in the request environment, but that does not happen until this method is called.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-session-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-session-source'>    <span class="ruby-comment"># File lib/roda/plugins/sessions.rb</span>
<span class="line-num">242</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">session</span>
<span class="line-num">243</span>   <span class="ruby-ivar">@env</span>[<span class="ruby-string">&#39;rack.session&#39;</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">_load_session</span>
<span class="line-num">244</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-session_created_at'>
<a name='method-i-session_created_at'></a>
<div class='synopsis'>
<span class='name'>session_created_at</span><span class='arguments'>()</span>

</div>
<div class='description'>

<p>The time the session was originally created. nil if there is no active session.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-session_created_at-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-session_created_at-source'>    <span class="ruby-comment"># File lib/roda/plugins/sessions.rb</span>
<span class="line-num">247</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">session_created_at</span>
<span class="line-num">248</span>   <span class="ruby-identifier">session</span>
<span class="line-num">249</span>   <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span>(<span class="ruby-ivar">@env</span>[<span class="ruby-constant">SESSION_CREATED_AT</span>]) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@env</span>[<span class="ruby-constant">SESSION_SERIALIZED</span>]
<span class="line-num">250</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-session_updated_at'>
<a name='method-i-session_updated_at'></a>
<div class='synopsis'>
<span class='name'>session_updated_at</span><span class='arguments'>()</span>

</div>
<div class='description'>

<p>The time the session was last updated. nil if there is no active session.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-session_updated_at-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-session_updated_at-source'>    <span class="ruby-comment"># File lib/roda/plugins/sessions.rb</span>
<span class="line-num">253</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">session_updated_at</span>
<span class="line-num">254</span>   <span class="ruby-identifier">session</span>
<span class="line-num">255</span>   <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span>(<span class="ruby-ivar">@env</span>[<span class="ruby-constant">SESSION_UPDATED_AT</span>]) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@env</span>[<span class="ruby-constant">SESSION_SERIALIZED</span>]
<span class="line-num">256</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
</div>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna"><strong>Hanna</strong> RDoc template</a>
</div>
</body>
</html>
